---
layout: post
title:  DB 기초 시리즈2 - Join개념(물리적 join) 
date:   2019-02-01
description: DB 기초 시리즈2로 DB 물리적조인 join에 대한 설명입니다.
tags: [DB, Databases, 기초, DBMS, join, 면접, 조인]
category: [DB, 면접]
---




### DB JOIN 개념

> 조인이란  두 개 이상의 테이블을 하나의 집합으로 만드는 연산을 말합니다. 대체로 데이터베이스에서 데이터를 추출할 때 하나의 테이블 데이터 뿐만 아니라 그와 연관된 다른 테이블에서의 데이터를 한꺼번에 가져오는 경우가 많이 생깁니다. 그래서 DB의 성능은 Join의 성능이다라는 말까지 나오기도 합니다. 그래서 이번 포스트에서는 join에 대해서 알아보려고 합니다.

<br/>

**DB join**의 개념에는 물리적 조인과 논리적 조인이라는 개념이 존재합니다. 쉽게 풀이하자면 **물리적 조인은 조인의 방식**을, **논리적 조인은 조인의 종류**라고 할 수 있습니다. 일단 논리조인과 달리 물리조인은 sql문에서 사용하지 않습니다.(hint를 사용하여 정할 수는 있습니다.)  우리가 sql문안에서 논리 조인을 이용한 조인을 해오면 내부적으로 옵티마이저가 최적의 물리조인(조인의 방식)을 선택해 동작합니다. 물론 옵티마이저의 선택이 항상 최적의 선택이 될 수 없기 때문에 물리조인(조인의 방식)을 강제해야할 때가 있습니다. 그러므로 논리조인, 물리조인은 우리가 개발자가 되기 위해서배워야할 개념입니다. 이번 포스트에서는 물리적 조인에 대해서 다뤄보도록 하겠습니다.

------

<br/>

<br/>

### 물리적 조인의 종류

<br/>

**1. NL(Nested Loof) Join**

NL Join은 이중 for문과 유사한 방식으로 조인을 수행합니다. 반복문의 외부 테이블을 Outer table이라고 하고, 내부 테이블을 Inner Table이라고 합니다. 

전체적인 흐름은 이렇습니다.

1. 선행 테이블에서 주어진 조건을 만족하는 행을 찾음 -> 2. 선행 테이블의 조인 키 값을 가지고 후행 테이블에서 조인 수행 

1. 선행 테이브르이 조건을 만족하는 모든 행에 대해 1번 작업 반복 수행

이 작업은 선행 테이블의 조건을 만족하는 모든 행의 수만큼 반복하기 때문에 조건을 만족하는 행의 수가 많으면 그 만큼 후행 테이블의 조인 작업은 반복 수행하게 됩니다. 따라서 결과 행의 수가 적은 테이블을 선행테이블로 선택하는 것이 더 효율적입니다. 

<br/>

더 구체적인 흐름을 그림과 함께 살펴보도록 하겠습니다.

![image-20190201184454173](/assets/img/image-20190201184454173.png)

[그림 참조 http://www.dbguide.net/db.db?boardConfigUid=9&boardIdx=136&boardStep=1&boardUid=148210&categoryUid=2]

위의 그림은 NL의 Join에 대한 설명입니다. 그림을 보면서 더 자세히 설명드리도록 하겠습니다.

1. 선행 테이블에서 조건을 만족하는 첫 번째 행을 찾습니다.(조건에 만족하지 않은 행들은 필터링 됨) -> 

1. 선행 테이블의 조인 키를 가지고 후행 테이블에 조인 키가 존재하는지 찾으러 갑니다. -> 
2. 후행 테이블의 인덱스에 선행 테이블의 조인 키가 존재하는지 확인합니다.(선행테이블의 조인키가 후행 테이블에 없으면 해당 행은 필터링 됨) -> 
3. 인덱스에서 추출한 레코드 식별자를 이용하여 후행 테이블에 액세스 (후행 테이블의 조건을 확인하고 조건에 맞으면 추출 버퍼에 넣습니다.) -> 
4. 이 작업을 끝날 때 까지 반복합니다. 

여기서 추출버퍼는 실행결과를 보관하는 버퍼로서 일정 크기를 설정하여 모두 차거나 더 이상 결과가 없을 경우 결과를 사용자에게 반환합니다. 



<br/><br/><br/><br/>



**2.Sort Merge Join**

조인 컬럼을 기준으로 데이터를 정렬하여 조인을 수행합니다. NL join은 주로 랜덤 액세스 방식으로 데이터를 읽는 반면 Sort Merge Join은 주로 스캔 방식으로 데이터를 읽습니다. 여기서 랜덤 액세스 방식은 이름 때문에 오해를 할 수 있는데 한번에 하나씩 데이터에 액세스하는 방식은 랜덤 액세스 방식이라고하며 스캔 방식과 반대되는 개념이라고 할 수 있습니다.(참고 http://www.gurubee.net/lecture/2230) Sort Merge Join은 넓은 범위의 데이터를 처리할 때 NL Join으로 하면 비효율적이기 때문에 많이 썻던 방식이지만 만약 정렬할 데이터가 많아 메모리에서 모든 정렬 작업을 수행하기 어려운 경우에는 임시 영역(디스크)을 사용하기 때문에 성능이 떨어질 수 있습니다. 그래서 많은 정렬 작업을 필요로하는 경우에는 Sort Merge Join보다는 CPU 작업 위주로 처리하는 Hash Join이 성능상 유리합니다. 그러나 Sort Merge Join은 Hash Join과 달리 동등 조인 뿐만 아니라 비동등 조인에 대해서도 조인 작업이 가능하다는 장점이 있습니다. 

<br/>

그림과 함께 구체적인 흐름을 살펴보도록 하겠습니다.

![image-20190201190757368](/assets/img/image-20190201190757368.png)



[그림 참조 http://www.dbguide.net/db.db?boardConfigUid=9&boardIdx=136&boardStep=1&boardUid=148210&categoryUid=2]

위의 그림은 Sort Merge Join에 대한 설명입니다. 그림과 함께 흐름을 살펴보겠습니다. 

1. 선행 테이블에서 주어진 조건을 만족하는 행을 찾습니다. -> 

2. 선행 테이블의 조인 키를 기준으로 정렬 작업을 수행 ->

   선행테이블의 조건을 만족하는 모든 행에 대해서 1,2 번 작업을 반복 수행합니다. (여기서 의문점이 생길 수 있습니다. 분명 Sort Merge Join은 스캔 방식으로 데이터를 읽는다고 했는데, 1,2번 작업의 반복은 랜덤 액세스 방식이기 때문인데요. 스캔 방식은 정렬된 테이블(여기서는 그림에서 2번, 4번)끼리 머지를 진행할 때 쓰입니다. 그래서 만약 처음 1,2번 작업이 많아진다면 랜덤액세스 방식이 많아지므로 Sort Merge Join의 장점이 사라질 수 있습니다. 참고http://www.gurubee.net/lecture/2405)

1. 후행 테이블에서 주어진 조건을 만족하는 행을 찾습니다. ->
2. 후행 테이블의 조인 키를 기준으로 정렬 작업을 수행합니다.  ->
3. 정렬된 결과를 이용하여 조인을 수행하며 조인에 성공하면 추출 버퍼에 넣습니다. 

<br/>

Sort Merge Join은 NL join처럼 조인 컬럼의 인덱스를 사용하지 않기 때문에 조인 컬럼의 인덱스가 존재하지 않을 경우에도 사용할 수 있는 조인 기법입니다. 



<br/><br/><br/><br/>



**3. Hash Join**

Hash Join은 해슁 기법을 이용한 조인입니다. 조인을 수행할 테이블의 조인 칼럼을 기준으로 해쉬 함수를 수행하여 서로 동일한 해쉬 값을 갖는 것들 사이에서 실제 값이 같은지를 비교하면서 조인을 수행합니다. Hash Join은 NL Join의 랜덤 액세스 문제점과 Sort Merge Join의 문제점인 정렬 작업의 부담을 해결하기 위한 대안으로 등장하였습니다. 

<br/>
그림과 함께 자세한 흐름을 살펴보도록 하겠습니다. 



![image-20190201195543808](/assets/img/image-20190201195543808.png)

[그림 참조 http://www.dbguide.net/db.db?boardConfigUid=9&boardIdx=136&boardStep=1&boardUid=148210&categoryUid=2]

위의 그림은 Hash Join에 대한 설명입니다. 그림과 함께 흐름을 살펴보도록 하겠습니다. 

1. 선행 테이블에서 주어진 조건을 만족하는 행을 찾습니다. ->
2. 선행 테이블의 조인 키를 기준으로 해쉬 함수를 적용하여 해쉬 테이블을 생성합니다. (이 대 해쉬테이블에는 조인 컬럼과 함께 Select 절에서 필요로 하는 칼럼도 함께 저장됩니다. ) 1,2번을 조건을 만족하는 모든 행에 대해서 반복합니다. ->
3. 후행 테이블에서 주어진 조건을 만족하는 행을 찾습니다. ->
4. 후행 테이블의 조인 키를 기준으로 해쉬 함수를 적용하여 해당 버킷을 찾습니다. ->
5. 조인에 성공하면 추출 버퍼에 넣습니다. 3~5번 작업을 조건을 만족하는 모든 행에 대해서 반복합니다.

<br/>

Hash Join은 조인 컬럼의 인덱스를 사용하지 않기 때문에 조인 컬럼의 인덱스가 존재하지 않을 경우에도 사용할 수 있습니다. Hash Join은 해쉬 함수를 이용하여 조인을 수행하기 때문에 '='로 수행하는 조인 즉, 동등 조인에서만 사용할 수 있습니다. 

Hash Join은 조인을 하기 위해서 해쉬 테이블을 메모리에 생성해야 합니다. 생성된 해쉬 테이블의 크기가 메모리에 적재할 수 있는 크기보다 더 커지면 임시 영역(디스크)에 해쉬 테이블을 저장합니다. 그러면 추가적인 작업이 필요해지기 때문에 조건에 맞는 행이 적은 테이블을 선행테이블로 사용하는 것이 좋습니다. 



------



여기까지 DB 기초 시리즈2 - join개념(물리적 join)에 대해서 알아보았습니다. 다음 post는 논리적 join에 대해서 알아보도록 하겠습니다. 감사합니다.















#### 참고자료 

https://blog.naver.com/chsmanager/140202016634

http://www.dbguide.net/db.db?boardConfigUid=9&boardIdx=136&boardStep=1&boardUid=148210&categoryUid=2

https://blog.naver.com/chsmanager/140202016634

http://www.gurubee.net/lecture/2405

















